var t,e={d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},n={};function r(t){return Boolean(t.className)}function o(t){return!Boolean(t.className)}e.d(n,{Cq:()=>d,S1:()=>h,A8:()=>g}),function(t){t.text="text",t.space="space",t.lineBreak="lineBreak",t.pageBreak="pageBreak"}(t||(t={}));const s={logError(){},logException(){},log(){}};function a(t,e,n){return{call(r,o,s,a){var c;const i=a(s),l=null===(c=e.postFn)||void 0===c?void 0:c[o];if(l)try{l(r,t,s,i)}catch(t){n.logException(`proxy.call.${String(o)}`,t)}return i},set(r,o,s,a){var c;const i=null===(c=e.overrideSet)||void 0===c?void 0:c[o];if(i)try{const e=i(r,t,s);if(void 0!==e)return a(e)}catch(t){n.logException(`proxy.set.${String(o)}`,t)}return a(s)}}}function c(t,e=[]){function n(t,r,o){for(let s=o;s<e.length;s++){const o=e[s].get;if(o)return o(t,r,(()=>n(t,r,s+1)))}return Reflect.get(t,r)}function r(t,n,o,s,a){for(let c=a;c<e.length;c++){const a=e[c].call;if(a)return a(t,n,s,(e=>r(t,n,o,e,c+1)))}return o.apply(t,s)}function o(t,n,r,s){for(let a=s;a<e.length;a++){const s=e[a].set;if(s)return s(t,n,r,(e=>o(t,n,e,a+1)))}return Reflect.set(t,n,r)}const s=new Map;return{proxy:new Proxy(t,{get(t,e,o){let a=s.get(e);if(void 0!==a)return a;const c=n(t,e,0);return"function"==typeof c?(a=(...n)=>r(t,e,c,n,0),s.set(e,a),a):c},set:(t,e,n,r)=>o(t,e,n,0)}),addMidleware(t){e.push(t)}}}function i(t){return{middleware:{get(e,n,r){const o=r();return"function"!=typeof o&&t({type:"get",prop:String(n),result:o}),o},call(e,n,r,o){const s=o(r);return t({type:"call",prop:String(n),args:r,result:s}),s},set:(e,n,r,o)=>(t({type:"set",prop:String(n),args:[r]}),o(r))}}}function l(){return{metricsMap:new Map}}const u={overrideSet:{font:(t,e,n)=>(e.fontStyle=function(t){const e=/^(?:([\d\w]+) )?(?:(\w+) )?([\d\.]+)px (?:[\'\"])?([\w \-]+)(?:[\'\"])?$/.exec(t);if(e){const[t,n,r,o,s]=e;let a="400",c="normal";return n&&(isNaN(parseInt(n,10))?"italic"===n?(c="italic",a=isNaN(parseInt(r,10))?"bold"===r?"700":"400":r):a="bold"===n?"700":"400":(a=n,c=r||c)),`${a} ${c} ${parseFloat(o).toFixed(4)}px "${s}"`}return t}(n),n)},postFn:{measureText(t,e,[n],r){if(!e.fontStyle)return;let o=e.metricsMap.get(e.fontStyle);if(!o){o=new Map,e.metricsMap.set(e.fontStyle,o);const n=t.measureText("M");o.set("M",{chunk:n,charShifts:[]})}const s=n.substr(1,n.length-2),a=[];for(let e=1;e<s.length;e++){const n=s.substr(0,e),r=o.get(n);if(r)a.push(r.chunk);else{const e=t.measureText(n);o.set(n,{chunk:e,charShifts:[...a]}),a.push(e)}}o.set(s,{chunk:r,charShifts:a})}}};const p=[],f=[];function d(t){for(const e of p){const n=t(e.canvas,e.originalContext);n&&e.proxy.addMidleware(n)}f.push(t)}const g=l();function h(){!function(t){const e=self.HTMLCanvasElement.prototype.getContext;self.HTMLCanvasElement.prototype.getContext=function(...n){var r;const o=e.call(this,...n);try{const[e]=n;if("2d"===e&&null!==(s=o)&&void 0!==s.getTransform&&s.getTransform().is2D)return null!==(r=t(this,o))&&void 0!==r?r:o}catch(t){}var s;return o}}(((t,e)=>{const n=f.map((n=>n(t,e))).filter((t=>Boolean(t)));if(r(t)){let t=null,e=[];const r=[e],{middleware:o}=i((n=>{const o=performance.now();null!==t&&t+10<o&&(e=[],r.push(e)),e.push(n),t=o}));n.push(o)}if(o(t)){const{middleware:t}=function({state:t=l(),options:e}){return{state:t,middleware:a(t,u,e)}}({state:g,options:s});n.push(t)}const d=c(e,n);return p.push({canvas:t,originalContext:e,proxy:d}),d.proxy}))}h();var x=n.Cq,y=n.S1,v=n.A8;export{x as addMiddleware,y as init,v as textMeasuringState};